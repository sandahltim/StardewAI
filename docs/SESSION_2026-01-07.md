# Session: 2026-01-07 - Unified VLM Architecture + Rusty

## Summary

Redesigned StardewAI from dual-model (separate Eyes + Brain) to unified VLM architecture using a single multimodal model for both vision and planning. Introduced **Rusty**, the sarcastic AI farmhand.

## Part 1: Architecture Redesign (Morning)

### Before ‚Üí After
- **Before**: Qwen3-VL (remote, 8s latency) ‚Üí Nemotron (local, 0.6s) = ~8.6s per cycle
- **After**: Single Qwen3-VL-30B-A3B (local, ~1.1s) = unified perception + planning

### Files Created
1. `scripts/start-llama-server.sh` - Isolated server startup (port 8780)
2. `scripts/download_models.py` - Model downloader
3. `src/python-agent/unified_agent.py` - New unified agent
4. `config/settings.yaml` - Updated for unified model + modes
5. `docs/SETUP.md` - Setup documentation

### Models Downloaded (~70 GB total)
| Model | Size | Speed | Use Case |
|-------|------|-------|----------|
| Qwen3VL-30B-A3B | 18 GB | 139 tok/s | ‚≠ê Default - Best balance |
| Qwen3VL-8B-Thinking | 16 GB | 42 tok/s | Debugging (shows reasoning) |
| Qwen3VL-32B | 19 GB | 30 tok/s | Complex planning |
| Mistral-Small-3.2-24B | 16 GB | 39 tok/s | Backup/alternative |

---

## Part 2: Fixes & Testing (Afternoon)

### Issues Fixed
1. **CUDA not detected** - Added `LD_LIBRARY_PATH` to startup script
2. **Wrong mmproj matched** - Fixed model finder to match by size (Qwen3VL-8B vs 30B)
3. **JSON parse errors** - Hardened parser with 3 extraction strategies

### All Models Benchmarked ‚úÖ
- Qwen3VL-30B-A3B: **1.1s** per vision query, 139 tok/s
- Vision + planning in single inference call working

---

## Part 3: Meet Rusty (Evening)

### Personality Design
Rusty is the AI farmhand - sarcastic, self-aware, helpful but opinionated.

**Example outputs:**
- Morning: "It's the first day, and we're both fresh as a daisy. Time to start the farm life."
- Late night: "Player 1's still in the mines? Honestly, I'm not surprised. I'm about to pass out."

### Prompt Improvements
- Added Stardew Valley game knowledge (time, energy, farming, mining, social)
- Added personality examples and mood tracking
- Lowered temperature (0.7 ‚Üí 0.5) for more consistent JSON
- Added energy/weather/mood fields to perception

### Agent Updates
- ThinkResult now tracks: energy, holding, weather, mood
- Logging shows personality with emojis (üí™ full energy, üíÄ exhausted)
- Robust JSON parsing (markdown blocks, balanced braces, fallback)

---

## Completed Tasks

- [x] Test llama-server startup with Qwen3VL-30B-A3B
- [x] Test unified agent PoC
- [x] Benchmark all 4 models
- [x] Fix startup issues (CUDA, mmproj matching)
- [x] Harden JSON parsing
- [x] Create Rusty personality
- [x] Add game knowledge to prompt

## In Progress (Codex)

- [ ] Web UI for Player 1 ‚Üî Rusty communication

## Next Session: Live Trials

- [ ] Test Rusty with actual Stardew Valley running
- [ ] Tune prompt based on real gameplay
- [ ] Test co-op mode with controller input
- [ ] Verify split-screen capture works

---

## Quick Start for Next Session

```bash
# Terminal 1: Start server
cd /home/tim/StardewAI
bash scripts/start-llama-server.sh

# Terminal 2: Start Rusty (observe mode - no inputs)
source venv/bin/activate
python src/python-agent/unified_agent.py --observe --goal "Help with farming"

# Or co-op mode with controller
python src/python-agent/unified_agent.py --mode coop --goal "Help with farming"
```

## Known Issues

- Occasional JSON parse still possible (model adds extra text)
- Split-screen capture region may need tuning per monitor
- Context window at 8K - may need more for long sessions

---
*Session by Claude + Tim - 2026-01-07*
