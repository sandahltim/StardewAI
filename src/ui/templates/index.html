<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StardewAI Console</title>
  <link rel="stylesheet" href="/static/app.css" />
</head>
<body>
  <div class="page">
    <aside class="panel">
      <header class="panel__header">
        <div>
          <p class="kicker">StardewAI</p>
          <h1>Agent Console</h1>
        </div>
        <div class="status-pill">
          <span class="dot"></span>
          <span id="statusMode">Mode: {{ status.mode or "helper" }}</span>
        </div>
      </header>

      <section class="panel__section">
        <h2>Rusty Snapshot</h2>
        <p class="help">Latest perception and plan from the agent.</p>
        <div class="snapshot">
          <div class="snapshot__grid">
            <div class="snapshot__label">Location</div>
            <div id="stateLocation" class="snapshot__value">{{ status.location or "-" }}</div>
            <div class="snapshot__label">Time</div>
            <div id="stateTime" class="snapshot__value">{{ status.time_of_day or "-" }}</div>
            <div class="snapshot__label">Energy</div>
            <div id="stateEnergy" class="snapshot__value">{{ status.energy or "-" }}</div>
            <div class="snapshot__label">Holding</div>
            <div id="stateHolding" class="snapshot__value">{{ status.holding or "-" }}</div>
            <div class="snapshot__label">Weather</div>
            <div id="stateWeather" class="snapshot__value">{{ status.weather or "-" }}</div>
            <div class="snapshot__label">Menu</div>
            <div id="stateMenu" class="snapshot__value">{{ "yes" if status.menu_open else "no" }}</div>
          </div>
          <div class="snapshot__row">
            <span class="snapshot__label">Mood</span>
            <span id="rustyMood" class="snapshot__value">-</span>
          </div>
          <div class="snapshot__row">
            <span class="snapshot__label">Nearby</span>
            <span id="stateNearby" class="snapshot__value">{{ ", ".join(status.nearby) if status.nearby else "-" }}</span>
          </div>
          <div id="rustyMemoryEmpty" class="rusty-empty hidden">
            No memories yet. Run the agent to start recording.
          </div>
          <div id="rustyMemoryPanel" class="rusty-memory">
            <div class="snapshot__row">
              <span class="snapshot__label">Confidence</span>
              <div class="confidence">
                <div class="confidence-bar">
                  <div id="rustyConfidenceFill" class="confidence-bar__fill"></div>
                </div>
                <span id="rustyConfidenceValue" class="confidence-value">-</span>
              </div>
            </div>
            <div class="snapshot__row">
              <span class="snapshot__label">Days farming</span>
              <span id="rustyDays" class="snapshot__value">-</span>
            </div>
            <div class="snapshot__row">
              <span class="snapshot__label">Recent events</span>
              <ol id="rustyEvents" class="rusty-list">
                <li>None</li>
              </ol>
            </div>
            <div class="snapshot__row">
              <span class="snapshot__label">Known NPCs</span>
              <div class="rusty-npcs">
                <span id="rustyNpcCount" class="snapshot__value">0</span>
                <ol id="rustyNpcs" class="rusty-list">
                  <li>None</li>
                </ol>
              </div>
            </div>
          </div>
        </div>
        <div class="plan">
          <div class="plan__header">
            <strong>Action Plan</strong>
            <span id="planUpdated" class="meta">{{ status.last_tick or "" }}</span>
          </div>
          <ol id="planList" class="plan__list">
            {% if status.action_plan %}
            {% for action in status.action_plan %}
            <li>{{ action }}</li>
            {% endfor %}
            {% else %}
            <li>None</li>
            {% endif %}
          </ol>
        </div>
        <div class="daily-plan-card">
          <div class="vlm-subhead">Rusty's Plan</div>
          <div id="dailyPlanMeta" class="daily-plan__meta">Waiting for plan...</div>
          <div class="daily-plan__section">Current</div>
          <div id="dailyPlanFocus" class="daily-plan__focus">-</div>
          <div class="daily-plan__section">Todo</div>
          <ul id="dailyPlanTodo" class="daily-plan__list">
            <li>None</li>
          </ul>
          <div id="dailyPlanDone" class="daily-plan__done">Done: 0</div>
          <div class="daily-plan__bar">
            <div id="dailyPlanFill" class="daily-plan__fill"></div>
          </div>
          <div id="dailyPlanPercent" class="daily-plan__percent">0% complete</div>
        </div>
        <div class="daily-summary-card">
          <div class="vlm-subhead">Daily Summary</div>
          <div id="dailySummaryMeta" class="daily-summary__meta">Waiting for summary...</div>
          <div class="daily-summary__section">Yesterday</div>
          <ul id="dailySummaryYesterday" class="daily-summary__list">
            <li>None</li>
          </ul>
          <div class="daily-summary__section">Lessons Learned</div>
          <ul id="dailySummaryLessons" class="daily-summary__list">
            <li>None</li>
          </ul>
          <div class="daily-summary__section">Today's Goals</div>
          <ul id="dailySummaryGoals" class="daily-summary__list">
            <li>None</li>
          </ul>
        </div>
      </section>

      <section class="panel__section">
        <h2>VLM Dashboard</h2>
        <p class="help">Live VLM state and recent actions.</p>
        <div class="vlm-card">
          <div class="vlm-row">
            <span class="vlm-label">Status</span>
            <span id="vlmStatus" class="vlm-value">{{ status.vlm_status or "Idle" }}</span>
          </div>
          <div class="vlm-row">
            <span class="vlm-label">Perception</span>
            <span id="vlmPerception" class="vlm-value">
              {{ status.location or "-" }} | {{ status.time_of_day or "-" }} | Energy {{ status.energy or "-" }} | Holding {{ status.holding or "-" }}
            </span>
          </div>
          <div class="vlm-row">
            <span class="vlm-label">SMAPI</span>
            <span class="vlm-value">
              <span id="smapiStatus" class="smapi-status">Checking...</span>
              <span id="smapiLastSeen" class="smapi-last-seen"></span>
            </span>
          </div>
        </div>
        <div class="vlm-reasoning">
          <div class="vlm-subhead">Last Reasoning</div>
          <p id="vlmReasoning">{{ status.last_reasoning or "None" }}</p>
        </div>
        <div class="vision-debug-card">
          <div class="vlm-subhead">Vision Debug</div>
          <div class="vision-debug__row">
            <span class="vision-label">Observation</span>
            <span id="vlmObservation" class="vision-value">Waiting for observation...</span>
          </div>
          <div class="vision-debug__row">
            <span class="vision-label">Proposed</span>
            <span id="vlmProposed" class="vision-value">-</span>
          </div>
          <div class="vision-debug__row">
            <span class="vision-label">Validation</span>
            <span id="vlmValidation" class="vision-value">-</span>
          </div>
          <div class="vision-debug__row">
            <span class="vision-label">Executed</span>
            <span id="vlmExecuted" class="vision-value">-</span>
          </div>
          <div class="vision-debug__row">
            <span class="vision-label">Outcome</span>
            <span id="vlmOutcome" class="vision-value">-</span>
          </div>
        </div>
        <div class="vlm-error-card">
          <div class="vlm-subhead">VLM Errors</div>
          <div class="vlm-error__meta">
            <span id="vlmParseStats">{{ status.vlm_parse_success or 0 }} ok / {{ status.vlm_parse_fail or 0 }} fail</span>
            <span id="vlmParseLastTime">
              {% if status.vlm_errors %}{{ status.vlm_errors[-1].time }}{% else %}No errors{% endif %}
            </span>
          </div>
          <div id="vlmParseError" class="vlm-error__type">
            {% if status.vlm_errors %}{{ status.vlm_errors[-1].error }}{% else %}None{% endif %}
          </div>
          <div id="vlmParseRaw" class="vlm-error__raw">
            {% if status.vlm_errors %}{{ status.vlm_errors[-1].raw_response }}{% else %}-{% endif %}
          </div>
        </div>
        <div class="skill-status-card">
          <div class="vlm-subhead">Skill Status</div>
          <div id="skillStatusCount" class="skill-status__count">
            Skills available: {{ status.available_skills_count or 0 }}
          </div>
        </div>
        <div class="skill-history-card">
          <div class="vlm-subhead">Skill History</div>
          <div class="skill-history__summary">
            <span id="skillHistoryTotal">0 runs</span>
            <span id="skillHistorySuccess">0% success</span>
          </div>
          <div id="skillUsageBars" class="skill-history__bars">
            <div class="skill-bar empty">No data yet</div>
          </div>
          <div class="skill-history__failures">
            <div class="vlm-subhead">Recent Failures</div>
            <ol id="skillFailureList" class="skill-history-list">
              <li>None</li>
            </ol>
          </div>
        </div>
        <div class="action-failure-card">
          <div class="vlm-subhead">Action Failures</div>
          <div class="action-failure__section">Recent Phantom Failures</div>
          <ul id="actionFailureList" class="action-failure__list">
            <li>None</li>
          </ul>
          <div class="action-failure__section">Success Rates (last 50)</div>
          <div id="actionFailureStats" class="action-failure__stats">
            <div class="action-failure__bar empty">No data yet</div>
          </div>
        </div>
        <div class="lessons-card">
          <div class="lessons-header">
            <div class="vlm-subhead">Lessons Learned</div>
            <button id="lessonsReset" class="button small button--ghost" type="button">Reset</button>
          </div>
          <div id="lessonsCount" class="lessons-count">0 lessons</div>
          <ol id="lessonsList" class="lessons-list">
            <li>None</li>
          </ol>
        </div>
        <div class="commentary-card">
          <div class="vlm-subhead">Rusty Commentary</div>
          <p id="commentaryText" class="commentary-text">Waiting for commentary...</p>
          <div class="commentary-controls">
            <label class="commentary-label" for="coquiVoice">Voice</label>
            <select id="coquiVoice" class="input"></select>
            <label class="commentary-label" for="commentaryTts">TTS</label>
            <input id="commentaryTts" type="checkbox" />
            <label class="commentary-label" for="commentaryVolume">Volume</label>
            <input id="commentaryVolume" type="range" min="0" max="100" value="70" />
          </div>
        </div>
        <div class="session-stats-card">
          <div class="vlm-subhead">Session Stats</div>
          <div class="session-stats__row">
            <span>Uptime</span>
            <span id="sessionUptime">-</span>
          </div>
          <div class="session-stats__row">
            <span>Thinks</span>
            <span id="sessionThinks">0</span>
          </div>
          <div class="session-stats__row">
            <span>Actions</span>
            <span id="sessionActions">0</span>
          </div>
          <div class="session-stats__row">
            <span>Failures</span>
            <span id="sessionFailures">0</span>
          </div>
          <div class="session-stats__row">
            <span>Distance</span>
            <span id="sessionDistance">0 tiles</span>
          </div>
          <div class="session-stats__row">
            <span>Watered</span>
            <span id="sessionWatered">0</span>
          </div>
          <div class="session-stats__row">
            <span>Harvested</span>
            <span id="sessionHarvested">0</span>
          </div>
          <div class="session-stats__list">
            <div class="vlm-subhead">Action Types</div>
            <ol id="sessionActionTypes" class="session-types">
              <li>None</li>
            </ol>
          </div>
        </div>
        <div class="latency-card">
          <div class="vlm-subhead">Latency Graph</div>
          <div id="latencyGraph" class="latency-graph"></div>
          <div id="latencyStats" class="latency-stats">No samples</div>
        </div>
        <div class="vlm-actions">
          <div class="vlm-subhead">Last Actions</div>
          <ol id="vlmActions" class="vlm-actions__list">
            {% if status.last_actions %}
            {% for action in status.last_actions %}
            <li>{{ action }}</li>
            {% endfor %}
            {% else %}
            <li>None</li>
            {% endif %}
          </ol>
        </div>
        <div class="movement-card">
          <div class="movement-header">
            <span class="vlm-subhead">Movement History</span>
            <span id="movementStuck" class="movement-status">Moving</span>
          </div>
          <ol id="movementList" class="movement-list">
            <li>None</li>
          </ol>
          <div class="movement-trail">
            <span class="vlm-subhead">Direction Trail</span>
            <span id="movementTrail" class="movement-trail__value">-</span>
          </div>
        </div>
        <div class="compass-card">
          <div class="vlm-subhead">Directional Compass</div>
          <div class="compass-grid">
            <div class="compass-cell compass-empty"></div>
            <div class="compass-cell" id="compassUp"></div>
            <div class="compass-cell compass-empty"></div>
            <div class="compass-cell" id="compassLeft"></div>
            <div class="compass-cell compass-center">‚óè</div>
            <div class="compass-cell" id="compassRight"></div>
            <div class="compass-cell compass-empty"></div>
            <div class="compass-cell" id="compassDown"></div>
            <div class="compass-cell compass-empty"></div>
          </div>
          <p id="compassNote" class="compass-note">Waiting for surroundings...</p>
        </div>
        <div class="nav-intent-card">
          <div class="vlm-subhead">Navigation Intent</div>
          <div id="navTarget" class="nav-target">No target</div>
          <div class="nav-meta">
            <span id="navBlocked">Blocked: none</span>
            <span id="navAttempts">Move attempts: 0</span>
          </div>
        </div>
        <div class="tile-card">
          <div class="vlm-subhead">Tile State</div>
          <div id="tileStatus" class="tile-status">Waiting for tile data...</div>
          <div class="tile-progress" id="tileProgress">
            <span data-step="clear">CLEAR</span>
            <span data-step="tilled">TILL</span>
            <span data-step="planted">PLANT</span>
            <span data-step="watered">WATER</span>
            <span data-step="done">DONE</span>
          </div>
          <p id="tileNote" class="tile-note">-</p>
        </div>
        <div class="spatial-map-card">
          <div class="vlm-subhead">Spatial Map</div>
          <div class="spatial-map-legend">
            <span class="legend-item"><i class="legend-swatch tilled"></i> Tilled</span>
            <span class="legend-item"><i class="legend-swatch planted"></i> Planted</span>
            <span class="legend-item"><i class="legend-swatch watered"></i> Watered</span>
            <span class="legend-item"><i class="legend-swatch ready"></i> Ready</span>
            <span class="legend-item"><i class="legend-swatch obstacle"></i> Obstacle</span>
          </div>
          <div id="spatialMapGrid" class="spatial-map-grid"></div>
          <p id="spatialMapNote" class="spatial-map-note">Waiting for map data...</p>
        </div>
        <div class="farm-plan-card">
          <div class="vlm-subhead">Farm Plan</div>
          <div id="farmPlanMeta" class="farm-plan-meta">Waiting for plan...</div>
          <div id="farmPlanWorkflow" class="farm-plan-workflow">
            <span data-step="clear">CLEAR</span>
            <span data-step="till">TILL</span>
            <span data-step="plant">PLANT</span>
            <span data-step="water">WATER</span>
          </div>
          <div class="farm-plan-bar">
            <div id="farmPlanBarFill" class="farm-plan-bar__fill"></div>
          </div>
          <div id="farmPlanPercent" class="farm-plan-percent">0% complete</div>
          <div id="farmPlanGrid" class="farm-plan-grid"></div>
          <ol id="farmPlanRows" class="farm-plan-rows"></ol>
          <div class="farm-plan-legend">
            <span class="legend-item"><i class="legend-swatch farm-plan-done"></i> Done</span>
            <span class="legend-item"><i class="legend-swatch farm-plan-pending"></i> Pending</span>
            <span class="legend-item"><i class="legend-swatch farm-plan-current"></i> Current</span>
            <span class="legend-item"><i class="legend-swatch farm-plan-blocked"></i> Blocked</span>
          </div>
        </div>
        <div class="water-card">
          <div class="vlm-subhead">Watering Can</div>
          <div class="water-status" id="waterStatus">Waiting for state...</div>
          <div class="water-bar">
            <div id="waterFill" class="water-bar__fill"></div>
          </div>
          <p id="waterNote" class="water-note">-</p>
        </div>
        <div class="water-source-card">
          <div class="vlm-subhead">Water Source</div>
          <div id="waterSourceStatus" class="water-source-status">Waiting for surroundings...</div>
          <p id="waterSourceNote" class="water-note">-</p>
        </div>
        <div class="shipping-card">
          <div class="vlm-subhead">Shipping Bin</div>
          <div id="shippingStatus" class="shipping-status">Waiting for state...</div>
          <p id="shippingNote" class="water-note">-</p>
          <div class="shipping-history">
            <div class="shipping-history__header">
              <span>Today's Shipped</span>
              <span id="shippingTotal" class="shipping-total">0g</span>
            </div>
            <ol id="shippingList" class="shipping-list">
              <li>None</li>
            </ol>
          </div>
        </div>
        <div class="crop-card">
          <div class="vlm-subhead">Crop Growth</div>
          <ol id="cropProgress" class="crop-list">
            <li>None</li>
          </ol>
        </div>
        <div class="crop-countdown-card">
          <div class="vlm-subhead">Crop Countdown</div>
          <ol id="cropCountdown" class="crop-list">
            <li>None</li>
          </ol>
        </div>
        <div class="farming-cycle-card">
          <div class="vlm-subhead">Farming Cycle</div>
          <div class="farming-cycle__meta">
            <span id="farmingCycleDay">Day -</span>
            <span id="farmingCycleWeather">Weather: -</span>
          </div>
          <div class="farming-cycle__crop" id="farmingCycleCrop">No crop data</div>
          <div class="farming-cycle__bar">
            <div id="farmingCycleFill" class="farming-cycle__fill"></div>
          </div>
          <div id="farmingCycleProgress" class="farming-cycle__progress">-</div>
          <div class="farming-cycle__section">Today's Tasks</div>
          <ul id="farmingCycleTasks" class="farming-cycle__list">
            <li>Waiting for data...</li>
          </ul>
          <div class="farming-cycle__section">Recent Days</div>
          <ul id="farmingCycleHistory" class="farming-cycle__list">
            <li>No history yet.</li>
          </ul>
        </div>
        <div class="crop-status-card">
          <div class="vlm-subhead">Crop Status</div>
          <div id="cropStatus" class="crop-status">Waiting for crop data...</div>
          <p id="cropStatusNote" class="crop-status__note">-</p>
        </div>
        <div class="harvest-card">
          <div class="vlm-subhead">Harvest Ready</div>
          <div id="harvestStatus" class="harvest-status">Waiting for crop data...</div>
          <p id="harvestNote" class="crop-status__note">-</p>
        </div>
        <div class="stamina-card">
          <div class="vlm-subhead">Energy</div>
          <div id="staminaStatus" class="stamina-status">Waiting for state...</div>
          <div class="stamina-bar">
            <div id="staminaFill" class="stamina-bar__fill"></div>
          </div>
        </div>
        <div class="bedtime-card">
          <div class="vlm-subhead">Bedtime</div>
          <div id="bedtimeStatus" class="bedtime-status">Waiting for time...</div>
          <p id="bedtimeNote" class="bedtime-note">-</p>
        </div>
        <div class="day-season-card">
          <div class="vlm-subhead">Day/Season</div>
          <div id="daySeasonStatus" class="day-season-status">Waiting for time...</div>
          <div class="day-season-bar">
            <div id="daySeasonFill" class="day-season-bar__fill"></div>
          </div>
          <p id="daySeasonNote" class="bedtime-note">-</p>
        </div>
        <div class="inventory-card">
          <div class="vlm-subhead">Toolbar Inventory</div>
          <div id="inventoryGrid" class="inventory-grid">
            {% for slot in range(12) %}
            <div class="inventory-slot">
              <div class="inventory-slot__index">{{ slot }}</div>
              <div class="inventory-slot__name">Empty</div>
              <div class="inventory-slot__stack">-</div>
            </div>
            {% endfor %}
          </div>
        </div>
        <div class="instruction-card">
          <div class="vlm-subhead">Current Instruction</div>
          <div id="currentInstruction" class="instruction-text">No instruction yet.</div>
        </div>
        <div class="location-card">
          <div class="vlm-subhead">Location</div>
          <div id="locationDisplay" class="location-display">Unknown</div>
          <div id="positionDisplay" class="position-display">(?, ?)</div>
        </div>
        <div class="action-log-card">
          <div class="vlm-subhead">Action Results</div>
          <ol id="actionLog" class="action-log">
            <li>None</li>
          </ol>
        </div>
        <div class="action-history-card">
          <div class="vlm-subhead">Action History</div>
          <ol id="actionHistory" class="action-log">
            <li>None</li>
          </ol>
        </div>
        <div class="action-repeat-card">
          <div class="vlm-subhead">Action Repeat</div>
          <div id="actionRepeat" class="action-repeat">No repeats detected</div>
        </div>
        <div class="goal-progress-card">
          <div class="vlm-subhead">Goal Progress</div>
          <div id="goalProgressSummary" class="goal-progress__summary">No tasks</div>
          <ol id="goalProgressList" class="goal-progress__list">
            <li>None</li>
          </ol>
        </div>
        <details class="session-timeline">
          <summary>Session Timeline</summary>
          <ol id="sessionTimeline" class="session-timeline__list">
            <li>None</li>
          </ol>
        </details>
        <div class="memory-viewer">
          <div class="memory-header">
            <span class="vlm-subhead">Memory Viewer</span>
          </div>
          <div class="memory-search">
            <input id="memorySearch" class="input" placeholder="Search episodic memories" />
            <button id="memorySearchBtn" class="button small">Search</button>
          </div>
          <div class="memory-block">
            <div class="vlm-subhead">Recent Episodic Memories</div>
            <ol id="memoryList" class="memory-list">
              <li>None</li>
            </ol>
          </div>
          <div class="memory-block">
            <div class="vlm-subhead">Knowledge Lookups</div>
            <ol id="knowledgeList" class="memory-list">
              <li>None</li>
            </ol>
          </div>
        </div>
      </section>

      <section class="panel__section">
        <h2>Mode</h2>
        <p class="help">Desired mode informs the agent next run.</p>
        <div class="field-row">
          <select id="modeSelect" class="input">
            <option value="helper" {% if (status.desired_mode or "helper") == "helper" %}selected{% endif %}>Helper</option>
            <option value="coop" {% if (status.desired_mode or "helper") == "coop" %}selected{% endif %}>Co-op</option>
          </select>
          <button id="modeUpdate" class="button">Set</button>
        </div>
      </section>

      <section class="panel__section">
        <h2>Co-op Safety</h2>
        <p class="help">Require confirmation before executing actions.</p>
        <div class="field-col">
          <label class="toggle">
            <input id="modeFree" type="radio" name="safetyMode" value="free" {% if not status.confirm_before_execute %}checked{% endif %} />
            <span>Free mode (no confirm)</span>
          </label>
          <label class="toggle">
            <input id="modeConfirm" type="radio" name="safetyMode" value="confirm" {% if status.confirm_before_execute %}checked{% endif %} />
            <span>Confirm mode</span>
          </label>
          <button id="confirmGrant" class="button" {% if not status.confirm_before_execute %}disabled{% endif %}>Allow Next Action</button>
        </div>
        <div class="pending">
          <div class="pending__header">
            <strong>Pending Action</strong>
            <span id="pendingAt" class="meta">{{ status.pending_action_at or "" }}</span>
          </div>
          <p id="pendingText">{{ status.pending_action or "None" }}</p>
          <div class="field-row">
            <button id="confirmApprove" class="button small" {% if not status.confirm_before_execute %}disabled{% endif %}>Approve</button>
            <button id="confirmClear" class="button small button--ghost">Clear</button>
          </div>
        </div>
      </section>


      <section class="panel__section">
        <h2>Current Goal</h2>
        <p class="help">Long-term objective for the agent.</p>
        <div class="field-col">
          <input id="goalInput" class="input" placeholder="e.g., Help water crops" value="{{ active_goal.text if active_goal }}" />
          <button id="goalUpdate" class="button">Update Goal</button>
        </div>
      </section>

      <section class="panel__section">
        <h2>Team Chat</h2>
        <p class="help">Coordinate with Claude and Tim.</p>
        <div id="teamFeed" class="team-feed"></div>
        <div class="team-input">
          <select id="teamSender" class="input">
            <option value="codex" selected>codex</option>
            <option value="claude">claude</option>
            <option value="tim">tim</option>
          </select>
          <input id="teamInput" class="input" placeholder="Send a team update..." />
          <button id="teamSend" class="button">Send</button>
        </div>
      </section>

      <section class="panel__section">
        <h2>Task Queue</h2>
        <p class="help">Free-form task plus optional structured fields.</p>
        <div class="field-col">
          <input id="taskTitle" class="input" placeholder="Task title (free-form)" />
          <div class="grid">
            <input id="taskLocation" class="input" placeholder="Location" />
            <input id="taskTool" class="input" placeholder="Tool" />
            <input id="taskPriority" class="input" placeholder="Priority (0-5)" type="number" min="0" max="5" />
            <input id="taskDue" class="input" placeholder="Due (e.g., Day 4 2pm)" />
            <select id="taskMode" class="input">
              <option value="">Mode (optional)</option>
              <option value="helper">Helper</option>
              <option value="coop">Co-op</option>
            </select>
            <input id="taskNotes" class="input" placeholder="Notes" />
          </div>
          <button id="taskAdd" class="button">Add Task</button>
        </div>

        <div id="taskList" class="task-list">
          {% for task in tasks %}
          <div class="task" data-task-id="{{ task.id }}">
            <div>
              <input class="input task-title" value="{{ task.title }}" />
              <div class="meta">
                <label>Priority</label>
                <input class="input task-priority" type="number" min="0" max="5" value="{{ task.priority }}" />
                <span>{% if task.mode %}{{ task.mode }}{% endif %}</span>
              </div>
              <div class="details">
                <input class="input task-notes" placeholder="Notes" value="{{ task.details.notes if task.details }}" />
                <input class="input task-location" placeholder="Location" value="{{ task.details.location if task.details }}" />
                <input class="input task-tool" placeholder="Tool" value="{{ task.details.tool if task.details }}" />
                <input class="input task-due" placeholder="Due" value="{{ task.details.due if task.details }}" />
              </div>
            </div>
            <div class="task-actions">
              <select class="input task-status">
                <option value="queued" {% if task.status == "queued" %}selected{% endif %}>Queued</option>
                <option value="active" {% if task.status == "active" %}selected{% endif %}>Active</option>
                <option value="done" {% if task.status == "done" %}selected{% endif %}>Done</option>
                <option value="blocked" {% if task.status == "blocked" %}selected{% endif %}>Blocked</option>
              </select>
              <button class="button small task-save">Save</button>
            </div>
          </div>
          {% endfor %}
        </div>
      </section>
    </aside>

    <main class="chat">
      <header class="chat__header">
        <h2>Conversation</h2>
        <div class="status">
          <span id="statusRunning">Running: {{ "yes" if status.running else "no" }}</span>
          <span id="statusTick">Last tick: {{ status.last_tick or "-" }}</span>
          <span id="statusConfirm">Confirm: {{ "on" if status.confirm_before_execute else "off" }}</span>
          <span id="statusGrant">Grant: {{ "yes" if status.confirm_granted else "no" }}</span>
          <span id="statusError" class="error">{{ status.last_error or "" }}</span>
        </div>
      </header>

      <section class="quick-bar">
        <div class="quick-bar__group">
          <label class="quick-bar__label" for="quickMode">Mode</label>
          <select id="quickMode" class="input">
            <option value="helper" {% if (status.desired_mode or "helper") == "helper" %}selected{% endif %}>Helper</option>
            <option value="coop" {% if (status.desired_mode or "helper") == "coop" %}selected{% endif %}>Co-op</option>
          </select>
          <button id="quickModeSet" class="button small">Set</button>
        </div>
        <div class="quick-bar__group">
          <label class="quick-bar__label" for="quickGoal">Goal</label>
          <input id="quickGoal" class="input" placeholder="Set quick goal" value="{{ active_goal.text if active_goal }}" />
          <button id="quickGoalSet" class="button small">Update</button>
        </div>
        <div class="quick-bar__group">
          <span class="quick-bar__label">Safety</span>
          <label class="toggle">
            <input id="quickFree" type="radio" name="quickSafety" value="free" {% if not status.confirm_before_execute %}checked{% endif %} />
            <span>Free</span>
          </label>
          <label class="toggle">
            <input id="quickConfirm" type="radio" name="quickSafety" value="confirm" {% if status.confirm_before_execute %}checked{% endif %} />
            <span>Confirm</span>
          </label>
        </div>
      </section>

      <section class="chat__input">
        <textarea id="chatInput" class="input" rows="3" placeholder="Send a message to the agent..."></textarea>
        <button id="chatSend" class="button">Send</button>
      </section>

      <section id="pendingBanner" class="pending-banner {% if not status.pending_action %}hidden{% endif %}">
        <div class="pending-banner__title">Next action preview</div>
        <div class="pending-banner__meta">
          <span id="pendingBannerText">{{ status.pending_action or "" }}</span>
          <span id="pendingBannerId">{{ status.pending_action_id or "" }}</span>
          <span id="pendingBannerAt">{{ status.pending_action_at or "" }}</span>
        </div>
        <div class="pending-banner__actions">
          <button id="pendingBannerApprove" class="button small" {% if not status.confirm_before_execute %}disabled{% endif %}>Approve</button>
          <button id="pendingBannerDeny" class="button small button--ghost">Deny</button>
        </div>
      </section>

      <section id="chatFeed" class="chat__feed">
        {% for message in messages|reverse %}
        <article class="message message--{{ message.role }}">
          <header>
            <span class="role">{{ message.role }}</span>
            <span class="timestamp">{{ message.created_at }}</span>
            {% if message.role == "agent" %}
            <button class="button small speak-button" data-message-id="{{ message.id }}">Speak</button>
            {% endif %}
          </header>
          <p>{{ message.content }}</p>
          {% if message.reasoning %}
          <details class="reasoning" open>
            <summary>Reasoning</summary>
            <div>{{ message.reasoning }}</div>
          </details>
          {% endif %}
        </article>
        {% endfor %}
      </section>
    </main>
  </div>

  <script src="/static/app.js"></script>
</body>
</html>
