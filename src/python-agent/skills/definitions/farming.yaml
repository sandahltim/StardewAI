# Farming Skills for StardewAI
# These skills handle crop management on the farm

# =============================================================================
# WATERING
# =============================================================================

water_crop:
  description: "Water an unwatered planted crop (auto-equips watering can)"
  category: farming
  energy_cost: 2

  preconditions:
    required:
      - type: has_item
        item: Watering Can

  actions:
    - select_item_type: Watering Can
    - face: "{target_direction}"
    - use_tool

  on_success:
    message: "Watered the crop"
    updates:
      - crop.isWatered: true

  on_failure:
    no_tool:
      message: "No watering can in inventory"
    can_empty:
      message: "Watering can is empty"
      recovery_skill: refill_watering_can

refill_watering_can:
  description: "Refill watering can at a water source (pond, river, well)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: adjacent_to
        target: water_source

  actions:
    # Auto-equip watering can (slot 2) before refilling
    - select_item_type: Watering Can
    - wait: 0.2
    - face: "{target_direction}"
    - wait: 0.1
    - use_tool

  on_success:
    message: "Refilled watering can"

  on_failure:
    not_adjacent:
      message: "Not adjacent to water"
      recovery_skill: navigate_to_water

go_refill_watering_can:
  description: "Navigate to water and refill watering can (use when can is EMPTY)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: has_item
        item: Watering Can

  actions:
    # Step 1: Navigate directly TO water (will stop at edge since can't walk on water)
    - pathfind_to:
        target: nearest_water
        stop_adjacent: false
    - wait: 0.3
    # Step 2: Equip watering can
    - select_item_type: Watering Can
    - wait: 0.2
    # Step 3: Try each direction to find water and refill
    # South (most common - ponds usually south of farmable area)
    - face: south
    - wait: 0.1
    - use_tool
    - wait: 0.3
    # East
    - face: east
    - wait: 0.1
    - use_tool
    - wait: 0.3
    # West
    - face: west
    - wait: 0.1
    - use_tool
    - wait: 0.3
    # North
    - face: north
    - wait: 0.1
    - use_tool

  on_success:
    message: "Refilled watering can at water source"

  on_failure:
    no_water:
      message: "No water source found nearby"
    path_blocked:
      message: "Cannot reach water"

equip_watering_can:
  description: "Select the watering can from toolbar"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: has_item
        item: Watering Can

  actions:
    - select_item_type: Watering Can

  on_success:
    message: "Equipped Watering Can"

  on_failure:
    no_item:
      message: "No Watering Can in inventory"

# =============================================================================
# HARVESTING
# =============================================================================

harvest_crop:
  description: "Pick a mature crop that is ready for harvest"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: adjacent_to
        target: ready_crop

  actions:
    - face: "{target_direction}"
    - harvest: "{target_direction}"

  on_success:
    message: "Harvested {crop_name}"
    updates:
      - inventory: add {crop_yield}

  on_failure:
    not_adjacent:
      message: "Not adjacent to a ready crop"
      recovery_skill: navigate_to_crop
    not_ready:
      message: "Crop is not ready for harvest yet"

# =============================================================================
# PLANTING
# =============================================================================

auto_plant_seeds:
  description: "Plant all seeds at optimal positions in row-by-row order (uses farm planner). Waters each seed after planting."
  category: farming
  energy_cost: 0
  requires_planning: true
  is_batch_operation: true  # Signals this triggers batch handler

  preconditions:
    required:
      - type: at_location
        location: Farm
      - type: has_item_category
        category: seeds

  planning:
    planner: farm_planner
    function: get_planting_sequence
    args: {}

  # Actions are handled by _batch_plant_seeds() in agent
  # This skill definition enables it to show up in skill list
  actions:
    - wait: 0.1  # Placeholder - actual work done by batch handler

  on_success:
    message: "Planted and watered all seeds in orderly rows"

  on_failure:
    no_seeds:
      message: "No seeds in inventory"
      recovery_skill: buy_seeds
    no_tilled:
      message: "No tilled soil available - need to till first"
      recovery_skill: till_soil

plant_seed:
  description: "Plant seeds on tilled soil (auto-selects seeds from inventory)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: standing_on
        target: tilled_soil
      - type: has_item_category
        category: seeds

  actions:
    - select_item_type: seed  # Auto-find and select seeds
    - use_tool  # Plant the selected seeds
    - wait: 0.3  # Give game time to update crop state

  on_success:
    message: "Planted seeds"
    updates:
      - tile.state: planted

  on_failure:
    wrong_tile:
      message: "Not standing on tilled soil"
      recovery_skill: till_soil
    no_seeds:
      message: "No seeds equipped"
      recovery_skill: equip_seeds

equip_seeds:
  description: "Select seeds from inventory"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: has_item_category
        category: seeds

  actions:
    - select_item_type: seed  # Auto-find seeds in inventory

  on_success:
    message: "Equipped seeds"

  on_failure:
    no_seeds:
      message: "No seeds in inventory - buy from Pierre's"

# =============================================================================
# SOIL PREPARATION
# =============================================================================

till_soil:
  description: "Use hoe to till adjacent ground for planting (specify direction)"
  category: farming
  energy_cost: 2

  preconditions:
    required:
      - type: has_item
        item: Hoe

  actions:
    - select_item_type: Hoe
    - face: "{target_direction}"  # VLM must specify: north/south/east/west
    - use_tool
    - wait: 0.3  # Give game time to update tile state

  on_success:
    message: "Tilled the soil to the {target_direction}"
    updates:
      - tile.state: tilled

  on_failure:
    no_tool:
      message: "No hoe in inventory"

equip_hoe:
  description: "Select the hoe from toolbar"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: has_item
        item: Hoe

  actions:
    - select_item_type: Hoe

  on_success:
    message: "Equipped Hoe"

# =============================================================================
# DEBRIS CLEARING
# =============================================================================

clear_weeds:
  description: "Cut weeds or grass with scythe (auto-equips, free energy!)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: has_item
        item: Scythe

  actions:
    - select_item_type: Scythe
    - face: "{target_direction}"
    - use_tool

  on_success:
    message: "Cleared weeds"
    drops: [Mixed Seeds, Fiber]

  on_failure:
    no_tool:
      message: "No scythe in inventory"

equip_scythe:
  description: "Select the scythe from toolbar"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: has_item
        item: Scythe

  actions:
    - select_item_type: Scythe

  on_success:
    message: "Equipped Scythe"

clear_stone:
  description: "Break small stones with pickaxe (auto-equips)"
  category: farming
  energy_cost: 2

  preconditions:
    required:
      - type: has_item
        item: Pickaxe

  actions:
    - select_item_type: Pickaxe
    - face: "{target_direction}"
    - use_tool

  on_success:
    message: "Cleared stone"
    drops: [Stone]

  on_failure:
    no_tool:
      message: "No pickaxe in inventory"

equip_pickaxe:
  description: "Select the pickaxe from toolbar"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: has_item
        item: Pickaxe

  actions:
    - select_item_type: Pickaxe

  on_success:
    message: "Equipped Pickaxe"

clear_wood:
  description: "Chop branches or twigs with axe (auto-equips)"
  category: farming
  energy_cost: 2

  preconditions:
    required:
      - type: has_item
        item: Axe

  actions:
    - select_item_type: Axe
    - face: "{target_direction}"
    - use_tool

  on_success:
    message: "Cleared wood"
    drops: [Wood]

  on_failure:
    no_tool:
      message: "No axe in inventory"

equip_axe:
  description: "Select the axe from toolbar"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: has_item
        item: Axe

  actions:
    - select_item_type: Axe

  on_success:
    message: "Equipped Axe"

chop_tree:
  description: "Chop down a tree (multiple hits required)"
  category: farming
  energy_cost: 10  # Trees take ~10 hits

  preconditions:
    required:
      - type: adjacent_to
        target: tree
      - type: equipped
        item: Axe

  actions:
    - face: "{target_direction}"
    - use_tool
    - use_tool
    - use_tool
    - use_tool
    - use_tool
    - use_tool
    - use_tool
    - use_tool
    - use_tool
    - use_tool

  on_success:
    message: "Chopped down tree"
    drops: [Wood, Tree Seeds]

  on_failure:
    not_adjacent:
      message: "Not adjacent to tree"
    wrong_tool:
      message: "Axe not equipped"
      recovery_skill: equip_axe

# =============================================================================
# SHIPPING / SELLING
# =============================================================================
# FUTURE ENHANCEMENTS:
# - ship_basic_crops: Only ship low-value (Parsnip, Potato, Bean)
# - ship_excess: Keep one of each type, ship rest
# - ship_non_artisan: Keep crops better as wine/jam (Ancient Fruit, Starfruit)
# - ship_with_exclusions: Config list of crops to never ship
# - check_bundle_needs: Don't ship crops needed for Community Center
# =============================================================================

# Ship crops - prioritizes vegetables, then fruits
# Does NOT ship raw materials (Wood, Sap, Fiber, Stone)
ship_crop:
  description: "Ship a vegetable crop (Parsnip, Potato, Cauliflower, etc.)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: at_location
        location: Farm

  actions:
    - select_item_type: crop  # Vegetables only
    - ship: -1

  on_success:
    message: "Shipped vegetable crop"

ship_fruit:
  description: "Ship a fruit crop (Blueberry, Melon, Strawberry, etc.)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: at_location
        location: Farm

  actions:
    - select_item_type: fruit  # Fruits only
    - ship: -1

  on_success:
    message: "Shipped fruit"

ship_item:
  description: "Ship a harvested crop (vegetables first, then fruits - NOT wood/sap/fiber)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: at_location
        location: Farm
      - type: has_sellable

  actions:
    # Try vegetables first (basic crops like Parsnip, Potato)
    # If no vegetables, will fail - future: fallback to fruits
    - select_item_type: crop
    - ship: -1

  on_success:
    message: "Shipped crop - will sell overnight"

  on_failure:
    not_on_farm:
      message: "Must be on Farm to ship items"
      recovery_skill: go_to_farm
    no_crops:
      message: "No crops in inventory to ship (wood/sap don't count)"

# =============================================================================
# SHOPPING / BUYING
# =============================================================================

buy_seeds:
  description: "Buy seeds from Pierre's shop (must be inside SeedShop)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: at_location
        location: SeedShop

  actions:
    - buy:
        item: "{seed_type}"
        quantity: "{quantity}"

  on_success:
    message: "Bought {quantity} {seed_type}"

  on_failure:
    wrong_location:
      message: "Not at Pierre's shop - go_to_pierre first"
      recovery_skill: go_to_pierre
    not_enough_money:
      message: "Not enough gold to buy seeds"
    shop_closed:
      message: "Pierre's is closed (Wed or outside 9AM-5PM)"

buy_parsnip_seeds:
  description: "Buy parsnip seeds (20g each, 4 days to grow, spring crop)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: at_location
        location: SeedShop
      - type: has_money
        amount: 20

  actions:
    - buy:
        item: "parsnip seeds"
        quantity: max

  on_success:
    message: "Bought parsnip seeds"

buy_cauliflower_seeds:
  description: "Buy cauliflower seeds (80g each, 12 days, spring crop, high value)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: at_location
        location: SeedShop
      - type: has_money
        amount: 80

  actions:
    - buy:
        item: "cauliflower seeds"
        quantity: max

  on_success:
    message: "Bought cauliflower seeds"

buy_potato_seeds:
  description: "Buy potato seeds (50g each, 6 days, spring crop, chance of bonus)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: at_location
        location: SeedShop
      - type: has_money
        amount: 50

  actions:
    - buy:
        item: "potato seeds"
        quantity: max

  on_success:
    message: "Bought potato seeds"

buy_kale_seeds:
  description: "Buy kale seeds (70g each, 6 days, spring crop, high profit)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: at_location
        location: SeedShop
      - type: has_money
        amount: 70

  actions:
    - buy:
        item: "kale seeds"
        quantity: max

  on_success:
    message: "Bought kale seeds"

buy_garlic_seeds:
  description: "Buy garlic seeds (40g each, 4 days, spring crop, fast growth)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: at_location
        location: SeedShop
      - type: has_money
        amount: 40

  actions:
    - buy:
        item: "garlic seeds"
        quantity: max

  on_success:
    message: "Bought garlic seeds"

buy_green_bean_starter:
  description: "Buy bean starter (60g each, 10 days, regrows every 3 days)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: at_location
        location: SeedShop
      - type: has_money
        amount: 60

  actions:
    - buy:
        item: "bean starter"
        quantity: 1

  on_success:
    message: "Bought 1 bean starter (60g)"

buy_tulip_bulb:
  description: "Buy tulip bulb (20g each, 6 days, spring flower, low profit)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: at_location
        location: SeedShop
      - type: has_money
        amount: 20

  actions:
    - buy:
        item: "tulip bulb"
        quantity: 1

  on_success:
    message: "Bought 1 tulip bulb (20g)"

buy_jazz_seeds:
  description: "Buy jazz seeds (30g each, 7 days, spring flower)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: at_location
        location: SeedShop
      - type: has_money
        amount: 30

  actions:
    - buy:
        item: "jazz seeds"
        quantity: 1

  on_success:
    message: "Bought 1 jazz seed (30g)"

buy_rice_shoot:
  description: "Buy rice shoot (40g each, 8 days, spring crop, grows near water)"
  category: farming
  energy_cost: 0

  preconditions:
    required:
      - type: at_location
        location: SeedShop
      - type: has_money
        amount: 40

  actions:
    - buy:
        item: "rice shoot"
        quantity: 1

  on_success:
    message: "Bought 1 rice shoot (40g)"

# =============================================================================
# COMPOSITE SKILLS (higher-level workflows)
# =============================================================================

water_all_crops:
  description: "Water all unwatered crops on the farm"
  category: farming
  composite: true

  steps:
    - skill: navigate_to_crop
      params: {target: nearest_unwatered}
    - skill: water_crop
      repeat_until: no_unwatered_crops

  on_complete:
    message: "All crops watered!"

harvest_all_ready:
  description: "Harvest all crops that are ready"
  category: farming
  composite: true

  steps:
    - skill: navigate_to_crop
      params: {target: nearest_ready}
    - skill: harvest_crop
      repeat_until: no_ready_crops

  on_complete:
    message: "All ready crops harvested!"

morning_farm_routine:
  description: "Complete morning farming chores: water crops, harvest ready, check animals"
  category: farming
  composite: true

  steps:
    - skill: harvest_all_ready
    - skill: water_all_crops
    - skill: ship_item
      condition: inventory_has_sellables

  on_complete:
    message: "Morning farm routine complete!"
